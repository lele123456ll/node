# TCP可靠性

## UDP TCP区别

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/501/udp-tcp%E5%8C%BA%E5%88%AB.png" alt="区别" style="zoom: 67%;" />

##  TCP如何保证可靠性

1. 应⽤数据被分割成 TCP 认为最适合发送的数据块
2. **检验和** ： `TCP保持它首部与数据的检验和`
3. **流量控制** : `TCP连接的每一方都有一个缓冲空间, 当发送方发送数据超过缓存时, 会降低发送方的速率, 防止包丢失`
4.  **拥塞控制** : `当网络拥塞时, 减少数据的发送`
5. **ARQ协议** : `等接收到接收方发送的确认信息, 才会继续发送数据`
6. **超时重传** : `当 TCP 发出⼀个段后，它启动⼀个定时器，等待⽬的端确认收到这个报⽂段。如果不能及时收到⼀个确认，将重发这个报⽂段`

### ARQ协议

**自动重传协议(Automatic Repeat-reQuest)**

- 停止等待ARQ协议

    - `原理 : 发送一个信息后等待对方返回确认信息, 接收到返回的确认信息后发送下一个信息`
    - **双方接收到重复信息直接丢弃**

    - **出现差错**
        - **超时重传** : `指只有没有接收到确认信息, 就会重传发送过的分组`
            - 确认丢失 : `继续发送`
            - 确认迟到 : `丢弃第二次确认信息`

- 连续ARQ协议

    - `原理 : 将整个组信息发送过去后, 确认最后一个分组的信息, 如果收到表示之前发送过得分组都已经正确收到`
    - **出现差错**
        - **GO-Back-N 回退N :  表示需要退回来重新发送已经发送过的N个信息**

### 滑动窗口和流量控制

> **TCP** **利⽤滑动窗⼝实现流量控制。流量控制是为了控制发送⽅发送速率，保证接收⽅来得及接**
>
> **收。** 接收⽅发送的确认报⽂中的窗⼝字段可以⽤来控制发送⽅窗⼝⼤⼩，从⽽影响发送⽅的发送
>
> 速率。将窗⼝字段设置为 0，则发送⽅不能发送数据。

### 拥塞控制

> 在某段时间，若对⽹络中**某⼀资源的需求超过了该资源所能提供的可⽤部分**，⽹络的性能就要变
>
> 坏。这种情况就叫拥塞

- TCP发送方维持一个**拥塞控制窗口(cwnd)**，动态发生变化

    > **接收方**根据自己的接收能力**设定了接收窗口rwnd**
    >
    > 
    >
    > **发送方窗口的上限值** = Min [rwnd, cwnd]
    >
    > 当**rwnd < cwnd** 时，是**接收方的接收能力限制发送方窗口的最大值**。
    >
    > 当**cwnd < rwnd** 时，是**网络的拥塞限制发送方窗口的最大值**。

    - 拥塞控制算法

        - **慢开始**&**拥塞避免**

            ```c++
            慢开始 : 由大到小逐渐增大发送窗口, cwnd初始为1, 每经过一个传播轮次, cwnd加倍.
            拥塞避免: 拥塞避免算法的思路是让拥塞窗⼝cwnd缓慢增⼤，即每经过⼀个往返时间RTT,就把发送放的cwnd加1
                
            //慢开始门限ssthresh状态变量
                if(cwnd < ssthresh) => 使用慢开始
                if(cwnd > ssthresh) => 拥塞避免
            ```

        - **快重传与快恢复**

            > ​	**不使用快重传的情况** : 发送方设置的**超时计时器时限已到**但还没有收到确认, TCP马上把拥塞窗口 **cwnd 减小到1**，并**执行慢开始**算法，同时把**慢开始门限值ssthresh减半**
            >
            > 
            >
            > ​	**快重传算法首先要求接收方每收到一个失序的报文段后就立即发出重复确认**。

            ![快重传](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/501/%E5%BF%AB%E9%87%8D%E4%BC%A0.jpg)

            ```c++
            快恢复
            	<1>. 当发送方连续收到三个重复确认，就执行“乘法减小”算法，把慢开始门限ssthresh减半。这是为了预防网络发生拥塞。请注意：接下去不执行慢开始算法。
            
                <2>. 由于发送方现在认为网络很可能没有发生拥塞，因此与慢开始不同之处是现在不执行慢开始算法（即拥塞窗口cwnd现在不设置为1），而是把cwnd值设置为 慢开始门限ssthresh减半后的数值，然后开始执行拥塞避免算法（“加法增大”），使拥塞窗口缓慢地线性增大。
            ```

            ![拥塞控制](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/501/%E6%8B%A5%E5%A1%9E%E6%8E%A7%E5%88%B6.jpg)
